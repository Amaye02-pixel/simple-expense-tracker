<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simple Expense Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; padding: 0 16px; }
    .row { display:flex; gap:8px; align-items:center; }
    input, select { padding:8px; font-size:14px; }
    table { width:100%; border-collapse: collapse; margin-top:12px; }
    th, td { padding:8px; border:1px solid #ddd; text-align:left; }
    .summary { margin-top:12px; }
  </style>
</head>
<body>
  <h1>Simple Expense Tracker</h1>

  <div>
    <h3>Add Expense</h3>
    <div class="row">
      <input id="description" placeholder="Description" />
      <input id="amount" placeholder="Amount" type="number" step="0.01" />
      <select id="category">
        <option>Food</option><option>Transport</option><option>Shopping</option><option>Bills</option><option>Other</option>
      </select>
      <button id="addBtn">Add</button>
    </div>
  </div>

  <div class="summary">
    <h3>Filters & Sorting</h3>
    <div class="row">
      <label>Start: <input id="start" type="date" /></label>
      <label>End: <input id="end" type="date" /></label>
      <label>Category:
        <select id="filterCategory">
          <option value="">All</option>
          <option>Food</option><option>Transport</option><option>Shopping</option><option>Bills</option><option>Other</option>
        </select>
      </label>
      <label>Sort:
        <select id="sort">
          <option value="date_desc">Newest</option>
          <option value="date_asc">Oldest</option>
          <option value="amount_desc">Amount ↓</option>
          <option value="amount_asc">Amount ↑</option>
        </select>
      </label>
      <button id="apply">Apply</button>
    </div>

    <h3>Summary</h3>
    <div id="summaryBox">Total: 0</div>
  </div>

  <h3>Expenses</h3>
  <table id="table">
    <thead><tr><th>Date</th><th>Description</th><th>Category</th><th>Amount</th><th>Action</th></tr></thead>
    <tbody></tbody>
  </table>

  <script>
    const api = '/api'
    async function fetchExpenses() {
      const start = document.getElementById('start').value
      const end = document.getElementById('end').value
      const category = document.getElementById('filterCategory').value
      const sort = document.getElementById('sort').value
      const params = new URLSearchParams()
      if (start) params.append('start', start)
      if (end) params.append('end', end)
      if (category) params.append('category', category)
      if (sort) {
        if (sort === 'amount_asc') params.append('sort','amount_asc')
        else if (sort === 'amount_desc') params.append('sort','amount_desc')
        else if (sort === 'date_asc') params.append('sort','date_asc')
        else params.append('sort','date_desc')
      }
      const res = await fetch(api + '/expenses?' + params.toString())
      const data = await res.json()
      const tbody = document.querySelector('#table tbody')
      tbody.innerHTML = ''
      data.data.forEach(e => {
        const tr = document.createElement('tr')
        tr.innerHTML = `<td>${new Date(e.created_at).toLocaleString()}</td><td>${e.description}</td><td>${e.category}</td><td>${e.amount.toFixed(2)}</td><td><button data-id="${e.id}" class="del">Delete</button></td>`
        tbody.appendChild(tr)
      })
      document.querySelectorAll('.del').forEach(b => b.onclick = async () => {
        const id = b.getAttribute('data-id')
        await fetch(api + '/expenses/' + id, { method: 'DELETE' })
        fetchExpenses()
      })
      // fetch summary
      const sres = await fetch(api + '/summary?' + params.toString())
      const sjson = await sres.json()
      const summaryBox = document.getElementById('summaryBox')
      summaryBox.innerHTML = 'Total: ' + (sjson.total || 0).toFixed(2) + '<br/>' + (sjson.by_category || []).map(c => `${c.category}: ${c.amount.toFixed(2)}`).join('<br/>')
    }

    document.getElementById('addBtn').onclick = async () => {
      const description = document.getElementById('description').value
      const amount = document.getElementById('amount').value
      const category = document.getElementById('category').value
      if (!description || !amount) return alert('Provide description and amount')
      await fetch(api + '/expenses', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ description, amount, category })
      })
      document.getElementById('description').value = ''
      document.getElementById('amount').value = ''
      fetchExpenses()
    }

    document.getElementById('apply').onclick = fetchExpenses

    // initial load
    fetchExpenses()
  </script>
</body>
</html>
